#!/usr/bin/env ruby

# Used for local testing
# $LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'huebot'

Huebot::CLI::Helpers.tap { |cli|
  case cli.get_cmd
  when :ls
    bridge, error = Huebot::Bridge.connect
    if error
      $stderr.puts error
      exit 1
    end
    retval = Huebot::CLI::Runner.ls bridge
    exit retval

  when :run
    opts, sources = cli.get_input!
    if sources.empty?
      cli.help!
      exit 1
    end

    bridge, error = Huebot::Bridge.connect
    if error
      $stderr.puts error
      exit 1
    end
    retval = Huebot::CLI::Runner.run(bridge, sources, opts)
    exit retval

  when :check
    opts, sources = cli.get_input!
    if sources.empty?
      cli.help!
      exit 1
    end

    bridge, error = Huebot::Bridge.connect
    if error
      $stderr.puts error
      exit 1
    end
    retval = Huebot::CLI::Runner.check(bridge, sources, opts)
    exit retval

  when :"get-state"
    opts, _sources = cli.get_input!
    if opts.inputs.empty?
      cli.help!
      exit 1
    end

    bridge, error = Huebot::Bridge.connect
    if error
      $stderr.puts error
      exit 1
    end
    retval = Huebot::CLI::Runner.get_state(bridge, opts.inputs)
    exit retval

  when :"set-ip"
    ip = cli.get_args(num: 1).first
    retval = Huebot::CLI::Runner.set_ip ip
    exit retval

  when :"clear-ip"
    cli.get_args(num: 0)
    retval = Huebot::CLI::Runner.unregister
    exit retval

  when :unregister
    cli.get_args(num: 0)
    retval = Huebot::CLI::Runner.unregister
    exit retval

  else cli.help!
  end
}
